{% include "base_layout.html" %}
   
    <div>
        <h1>Login:</h1>
        <form id="loginForm", onsubmit="postLogin(); return false;">
            <label for="login-email">Email:</label>
            <input type="text" id="login-email" name="login-email"><br>
            <label for="login-password">Password:</label>
            <input type="text" id="login-password" name="login-password"><br>
            <button type="submit">Login</button>
        </form>
        <p id="login-error-msg"></p>
    </div>
    <script>

      async function postLogin(){
          event.preventDefault(); // Prevent the form from submitting normally
          console.log("postLogin()");
          const url = "http://127.0.0.1:8080/api/auth/jwt/login";

          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;
        
          const params = new URLSearchParams();
          params.append('username', email);
          params.append('password', password);
          params.append('grant_type', '');
          params.append('client_secret', '');
          params.append('scope', '');

          try {
              const response = await axios.post(url, params);
              console.log(response.data);
              const token = response.data["access_token"];
              console.log(`Logged in, setting cookie ${token}`);
              document.cookie = `${email}=${token}`;
              window.location.href = "/join_game/" + email
          } catch (error) {
              console.log(`postLogin got an error: ${error}`);
              document.getElementById('login-error-msg').innerText = error.message || 'An error occurred';
          }
      }

      /*
        function getCookie(c_name)
        {
            var i,x,y,ARRcookies=document.cookie.split(";");
        
            console.log('ARRcookies.length = ',ARRcookies.length)
            for (i=0;i<ARRcookies.length;i++)
            {
                x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
                y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
                x=x.replace(/^\s+|\s+$/g,"");

                console.log(`ARRcookies[${i}]=${ARRcookies[i]}`);

                if (x==c_name)
                {
                    return unescape(y);
                }
             }
        }

        function verify(token){
            console.log("verify()");
            const url = "http://127.0.0.1:8080/api/auth/whoami";
      
            //token = getCookie("token")
      
            console.log("Verify says token is =",token)
      
            axios.get(url, {
              headers: {
                Authorization: `Bearer ${token}`,
              }
            })
              .then((response) => {
                console.log(response.data);
                console.log("Verified")      
                return true;
                
              })
              .catch(function(error) {
                console.log(error)
                console.log("Not logged in")
                return false;
              });
        }
        */

        //document.getElementById("loginForm").addEventListener("submit", postLogin);

        
    </script>
{% block body %}{% endblock %}