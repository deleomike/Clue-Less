{% include "base_layout.html" %}
    <div>
        <form id="loginForm", onsubmit="return false;">
            <label for="login-email">Email:</label>
            <input type="text" id="login-email" name="login-email"><br>
            <label for="login-password">Password:</label>
            <input type="text" id="login-password" name="login-password"><br>
            <button type="submit">Login</button>
        </form>
    </div>
    <script>
        function loginUser(username, password){
            console.log("loginUser()");
            const url = "/api/auth/jwt/login";
          
            const params = new URLSearchParams();
            params.append('username', username);
            params.append('password', password);
            params.append('grant_type', '');
            params.append('client_secret', '');
            params.append('scope', '');
          
            axios.post(url, params)
              .then((response) => {
                console.log(response.data);
                const token = response.data["access_token"]
                console.log(`Logged in, setting cookie ${token}`)
                document.cookie = `token=${token}`;
          
              })
              .catch( function(error) {
                console.log(error)
              });
          }

        async function postLogin(){
            console.log("postLogin()")
            const url = '/api/auth/jwt/login';

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            loginUser(email, password)
        }

        function getCookie(c_name)
        {
            var i,x,y,ARRcookies=document.cookie.split(";");
        
            for (i=0;i<ARRcookies.length;i++)
            {
                x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
                y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
                x=x.replace(/^\s+|\s+$/g,"");
                if (x==c_name)
                {
                    return unescape(y);
                }
             }
        }

        function verify(token){
            console.log("verify()");
            const url = "/api/auth/whoami";
      
            //token = getCookie("token")
      
            console.log(token)
      
            axios.get(url, {
              headers: {
                Authorization: `Bearer ${token}`,
              }
            })
              .then((response) => {
                console.log(response.data);
                console.log("Verified")
      
                window.location.href = "/";
      
                return response.data
                
              })
              .catch(function(error) {
                console.log(error)
                console.log("Not logged in")
              });
          }

        document.getElementById("loginForm").addEventListener("submit", postLogin);

        verify(getCookie("token"))

        console.log(`Cookie: ${document.cookie}`)
    </script>
{% block body %}{% endblock %}